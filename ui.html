<script type="text/javascript" src="https://momentjs.com/downloads/moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@latest/dist/chartjs-plugin-streaming.min.js"></script>

<div style="display: flex">
  <div>
    <canvas width="500" height="500" id="joy"></canvas>
  </div>
  <div>
    <canvas width="1000" height="500" id="myChart"></canvas>
  </div>
</div>
<script>
  let lastN = [];
  let waiting = false;

  const chart = new Chart(document.getElementById('myChart').getContext('2d'), {
    type: 'line',
    data: {
      datasets: [{
        label: 'x',
        data: [],
        fill: false,
        borderColor: '#f00',
        pointRadius: 0,
      }, {
        label: 'y',
        data: [],
        fill: false,
        borderColor: '#0ff',
        pointRadius: 0,
      }]
    },
    options: {
      scales: {
        xAxes: [{
          type: 'realtime',
          realtime: {delay: 1000},
        }],
      }
    }
  });

  function draw(x, y) {
    if (waiting) {
        return;
    }
    chart.data.datasets[0].data.push({
      x: Date.now(),
      y: x,
    });
    chart.data.datasets[1].data.push({
      x: Date.now(),
      y: y,
    });
    console.log(x, y);
    waiting = true;
    setTimeout(() => waiting = false, 50);
    function circle(cx, cy, fill, radius) {
      const canvas = document.getElementById('joy');
      const context = canvas.getContext('2d');
      const centerX = (250 * cx) + (canvas.width / 2);
      const centerY = (-250 * cy) + (canvas.height / 2);

      context.beginPath();
      context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
      context.fillStyle = fill;
      context.fill();
      context.lineWidth = 1;
      context.strokeStyle = '#003300';
      context.stroke();
    }

    circle(0, 0, '#fff', 500);
    circle(0, 0, '#ccc', 250);

    lastN.forEach(v => circle(...v, '#ddd', 15));
    lastN.push([x, y]);
    lastN = lastN.slice(-100);

    circle(x, y, '#f00', 20);
  }

  draw(0, 0);

  function open() {
    const ws = new WebSocket(`ws://${location.hostname}:${+location.port + 1}/ui`);
    ws.onmessage = m => draw(...m.data.split(',').map(x => +x));
    ws.onclose = () => setTimeout(open, 2000);
  }

  open();
</script>
